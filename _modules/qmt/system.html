

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qmt.system &mdash; QMT 0.0.1a documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> QMT
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parser.html">Parser class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system.html">System class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generator.html">Generator class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ga.html">GA class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serializer.html">Serializer class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timer.html">Timer class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">IO class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helper.html">helper Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QMT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>qmt.system</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qmt.system</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">kwant</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">as</span> <span class="nn">sla</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">cmocean</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">ConvexHull</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">.helper</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">coloredlogs</span><span class="o">,</span> <span class="nn">verboselogs</span>

<span class="c1"># create logger</span>
<span class="n">coloredlogs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">verboselogs</span><span class="o">.</span><span class="n">VerboseLogger</span><span class="p">(</span><span class="s1">&#39;QMT::Structure &#39;</span><span class="p">)</span>

<div class="viewcode-block" id="hoppingFunction"><a class="viewcode-back" href="../../system.html#qmt.system.hoppingFunction">[docs]</a><span class="k">def</span> <span class="nf">hoppingFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">site1</span><span class="p">,</span> <span class="n">site2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a function which returns the hopping value when a magnetic field is being applied.</span>

<span class="sd">    For the magnetic field: A value of 1 phi = 789436.238138607 Tesla!</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : The hopping parameter without a magnetic field being applied.</span>
<span class="sd">    phi : The magnetic flux though a single unit cell.</span>
<span class="sd">    site1 : A kwant site for the first lattice site.</span>
<span class="sd">    site2 : A kwant site for the second lattice site.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The hopping parameter with a magnetic field being applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeVectors</span><span class="p">()</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">site1</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">site2</span><span class="o">.</span><span class="n">pos</span>


    <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span></div>

<div class="viewcode-block" id="onSiteFunction"><a class="viewcode-back" href="../../system.html#qmt.system.onSiteFunction">[docs]</a><span class="k">def</span> <span class="nf">onSiteFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pot</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a function which returns the on-site potential when a magnetic field is being applied.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : The hopping parameter without a magnetic field being applied.</span>
<span class="sd">    phi : The magnetic flux though a single unit cell.</span>
<span class="sd">    site1 : A kwant site for the first lattice site.</span>
<span class="sd">    site2 : A kwant site for the second lattice site.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The hopping parameter with a magnetic field being applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pnj_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPNJunction</span><span class="p">()</span>
    <span class="n">on_site</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;turn_on&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">lead</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># pn-junction stuff</span>
        <span class="c1">###################################################</span>
        <span class="k">if</span> <span class="n">pointInHull</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull</span><span class="p">):</span>
            <span class="n">on_site</span> <span class="o">+=</span> <span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;p-potential&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">on_site</span> <span class="o">+=</span> <span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;n-potential&#39;</span><span class="p">]</span>
        <span class="c1">###################################################</span>



        <span class="c1"># magnetic field stuff</span>
        <span class="c1">###################################################</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeVectors</span><span class="p">()</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">B_in_T</span> <span class="o">=</span> <span class="mf">6.62607004e-34</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="mf">10e20</span> <span class="o">/</span> <span class="mf">1.60217662e-19</span>
        <span class="n">B_in_G</span> <span class="o">=</span> <span class="n">B_in_T</span> <span class="o">*</span> <span class="mf">1e4</span>
        <span class="n">on_site</span> <span class="o">+=</span> <span class="n">pot</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="mf">0.579e-8</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">*</span> <span class="n">B_in_G</span>
        <span class="c1">###################################################</span>

        <span class="k">return</span> <span class="n">on_site</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeVectors</span><span class="p">()</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">B_in_T</span> <span class="o">=</span> <span class="mf">6.62607004e-34</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="mf">10e20</span> <span class="o">/</span> <span class="mf">1.60217662e-19</span>
        <span class="n">B_in_G</span> <span class="o">=</span> <span class="n">B_in_T</span> <span class="o">*</span> <span class="mf">1e4</span>
        <span class="k">return</span> <span class="n">pot</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="mf">0.579e-8</span> <span class="o">*</span> <span class="n">spin</span> <span class="o">*</span> <span class="n">B_in_G</span></div>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../system.html#qmt.system.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main class which stores all of the information needed for kwant as well as functions to make it easier to use kwant (not that it is too difficult).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : This takes the YAML configuration file which is read in as a dictionary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>   <span class="bp">self</span><span class="p">,</span>
                    <span class="n">parser</span>
                 <span class="p">):</span>
        <span class="c1"># define the class parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getDevice</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leads</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getLeads</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">spinDependent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getMaskFunction</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># there is no mask to apply</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pnj_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPNJunction</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;turn_on&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># print(self.pnj_config[&#39;points&#39;])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">])</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">attachLeads</span><span class="p">()</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># first construct the lattice</span>
        <span class="n">lattice_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeType</span><span class="p">()</span>
        <span class="n">lattice_constant</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeConstant</span><span class="p">()</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeVectors</span><span class="p">()</span>
        <span class="n">lattice_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeBasis</span><span class="p">()</span>
        <span class="n">norbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getNumOrbitals</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lattice_type</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">,</span> <span class="n">lattice_basis</span><span class="p">,</span> <span class="n">norbs</span><span class="o">=</span><span class="n">norbs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Sorry, we do not support the lattice type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lattice_type</span><span class="p">))</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;hoppings&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;potentials&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
            
            <span class="c1"># if we want to consider spin dependent transport</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">neighbors</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">direction</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">direction</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">neighbors</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">direction</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">attachLeads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leads</span><span class="p">:</span>
                <span class="n">lead_range</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span>
                <span class="n">lead_vector</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span>
                <span class="n">lead_offset</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
                <span class="n">lead_pot</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span>
                <span class="n">lead_hopping</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;hopping&#39;</span><span class="p">]</span>
                <span class="n">lead_r</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>
                <span class="n">lead_shift</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span>
                <span class="n">lead_direction</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">TranslationalSymmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">orthogVecSlope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">lead_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_pot</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">lead_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_pot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">lead_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">lead_direction</span><span class="p">)</span>
                <span class="n">lead_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">lead_direction</span><span class="p">)</span>            
                <span class="n">lead_up</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
                <span class="n">lead_down</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_up</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_down</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lead_r</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_up</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_down</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leads</span><span class="p">:</span>
                <span class="n">lead_range</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span>
                <span class="n">lead_vector</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span>
                <span class="n">lead_offset</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
                <span class="n">lead_pot</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span>
                <span class="n">lead_hopping</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;hopping&#39;</span><span class="p">]</span>
                <span class="n">lead_r</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>
                <span class="n">lead_shift</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span>
                <span class="n">lead_direction</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">TranslationalSymmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">orthogVecSlope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">lead</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lead_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">lead_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_pot</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">lead</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getPhi</span><span class="p">(),</span> <span class="n">lead_direction</span><span class="p">)</span>
                <span class="n">lead</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lead_r</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">applyMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">site_value_pairs</span><span class="p">():</span>
            <span class="c1"># if the site is in the body</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># print (s.tag)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">min_tag_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">min_tag_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">min_pos_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">min_pos_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_pos_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">max_pos_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">tag_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_tag_sx</span>
        <span class="n">tag_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_tag_sy</span>

        <span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_tag_sx</span><span class="p">)</span>
        <span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_tag_sy</span><span class="p">)</span>
        <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_pos_sx</span><span class="p">)</span>
        <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_pos_sy</span><span class="p">)</span>
        <span class="n">masc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">mask</span><span class="p">((</span><span class="n">tag_length</span><span class="p">,</span> <span class="n">tag_width</span><span class="p">),</span> <span class="p">(</span><span class="n">min_pos_sx</span><span class="p">,</span> <span class="n">min_pos_sy</span><span class="p">),</span> <span class="p">(</span><span class="n">max_pos_sx</span><span class="p">,</span> <span class="n">max_pos_sy</span><span class="p">),</span> <span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">removed_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">masc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">removed_tags</span> <span class="o">=</span> <span class="n">removed_tags</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">removed_tags</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">removed_tags</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">system</span><span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="p">)]]</span>
        <span class="n">system</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">system</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getPreSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span>

    <span class="k">def</span> <span class="nf">getSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>

<div class="viewcode-block" id="Structure.visualizeSystem"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.visualizeSystem">[docs]</a>    <span class="k">def</span> <span class="nf">visualizeSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a plot to visualize the constructed system.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A pyplot object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span><span class="p">,</span> <span class="n">site_lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pnj_config</span><span class="p">[</span><span class="s1">&#39;turn_on&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">siteColours</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                    <span class="c1"># print(list(self.pre_system.sites())[site])</span>
                    <span class="k">if</span> <span class="n">pointInHull</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hull</span><span class="p">):</span>
                        <span class="k">return</span> <span class="s1">&#39;r&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;b&#39;</span>
                <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span><span class="p">,</span> <span class="n">site_lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">lead_site_lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">site_color</span><span class="o">=</span><span class="n">siteColours</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span><span class="p">,</span> <span class="n">site_lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">diagonalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># Compute some eigenvalues of the closed system</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">sparse_mat_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="n">sparse_mat_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat_up</span><span class="p">),</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat_down</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sparse_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat</span><span class="p">)</span>

<div class="viewcode-block" id="Structure.getConductance"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getConductance">[docs]</a>    <span class="k">def</span> <span class="nf">getConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the conductance between 2 leads.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lead_in : The id of the lead you would like to inject electrons.</span>
<span class="sd">        lead_out : The id of the lead you measuring the transmission through.</span>
<span class="sd">        energies : The range of energies that must be integrated over. By default, the energies are found from the minimum and maximum values in the band structure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The range of energies and either one or two (spin-dependent) vectors of conductance. i.e.</span>

<span class="sd">        (energies, conductances) </span>

<span class="sd">        or</span>

<span class="sd">        (energies, conductances_up, conductances_down)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">energies</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnergyRange</span><span class="p">()</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">energy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">data_up</span><span class="p">,</span> <span class="n">data_down</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">smatrix_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">smatrix_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">data_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix_up</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">))</span>
                <span class="n">data_down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix_down</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">energies</span><span class="p">,</span> <span class="n">data_up</span><span class="p">,</span> <span class="n">data_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">smatrix</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">energies</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Structure.getCurrent"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getCurrent">[docs]</a>    <span class="k">def</span> <span class="nf">getCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">,</span> <span class="n">avg_chem_pot</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the current between 2 leads.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lead_in : The id of the lead you are injecting electrons.</span>
<span class="sd">        lead_out : The id of the lead you would like to find the transmission through.</span>
<span class="sd">        avg_chem_pot : The average chemical potential difference. Default: 1.0. It is common practice to set this to the hopping energy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Either one or two (spin-dependent) values of current i.e.</span>

<span class="sd">        current</span>

<span class="sd">        or </span>

<span class="sd">        current_up, current_down</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getBias</span><span class="p">()</span>
        <span class="n">kb_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getKBT</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">cond_up</span><span class="p">,</span> <span class="n">cond_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConductance</span><span class="p">(</span><span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">)</span>
            <span class="n">de</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mu_left</span> <span class="o">=</span> <span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">mu_right</span> <span class="o">=</span> <span class="o">-</span><span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">diff_fermi</span> <span class="o">=</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">mu_left</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span> <span class="o">-</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">mu_right</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">de</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cond_up</span> <span class="o">*</span> <span class="n">diff_fermi</span><span class="p">),</span> <span class="n">de</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cond_down</span> <span class="o">*</span> <span class="n">diff_fermi</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConductance</span><span class="p">(</span><span class="n">lead_in</span><span class="p">,</span> <span class="n">lead_out</span><span class="p">)</span>
            <span class="n">de</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mu_left</span> <span class="o">=</span> <span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">mu_right</span> <span class="o">=</span> <span class="o">-</span><span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">diff_fermi</span> <span class="o">=</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">mu_left</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span> <span class="o">-</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">mu_right</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">de</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cond</span> <span class="o">*</span> <span class="n">diff_fermi</span><span class="p">)</span></div>



<div class="viewcode-block" id="Structure.getBandStructure"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getBandStructure">[docs]</a>    <span class="k">def</span> <span class="nf">getBandStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">momenta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the band structure of a certain lead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lead_id : The id of the lead the band structure will be calculated.</span>
<span class="sd">        momenta : The values of momenta for which you would like the band structure. Default: np.linspace(-np.pi, np.pi, self.grid_size)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A tuple with length 2 or three. Zeroth element is momenta and the rest are the energies for that momenta. For spin polarized systems it returns the bands for spin-up and spin-down (length 3 tuple).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">momenta</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">momenta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">bands_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">lead_id</span><span class="p">])</span>
            <span class="n">bands_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">lead_id</span><span class="p">])</span>
            <span class="n">energies_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands_up</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="n">energies_down</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands_down</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">momenta</span><span class="p">,</span> <span class="n">energies_up</span><span class="p">,</span> <span class="n">energies_down</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">lead_id</span><span class="p">])</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">momenta</span><span class="p">,</span> <span class="n">energies</span></div>

<div class="viewcode-block" id="Structure.getEnergyRange"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getEnergyRange">[docs]</a>    <span class="k">def</span> <span class="nf">getEnergyRange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the energy range that must be integrated over to calcuate the current.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list of length 2 with the zeroth element being the minimum and the first element being the maximum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">leads</span><span class="p">):</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">e_up</span><span class="p">,</span> <span class="n">e_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBandStructure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_up</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_up</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_down</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e_down</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">mins</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">leads</span><span class="p">):</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBandStructure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                <span class="n">maxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">mins</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxs</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Structure.getDOS"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getDOS">[docs]</a>    <span class="k">def</span> <span class="nf">getDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the density of states for the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        energies : An array of energies that we would like to calculate the LDOS at. Default is the minimum and maximum found from the bandstructure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Energies and DOS in the form of a tuple. If spin-dependent calculations are specified, it returns energies, DOS for spin up, DOS for spin down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">energies</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">energy_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnergyRange</span><span class="p">()</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">energy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">es</span><span class="p">,</span> <span class="n">DOS_up</span><span class="p">,</span> <span class="n">DOS_down</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="c1"># sometimes the ldos function returns an error for a certain value of energy</span>
                <span class="c1"># -- we therefore must use a try-except statement</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">LDOS_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">ldos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">LDOS_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">ldos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">es</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="c1"># integrate the ldos over all space</span>
                    <span class="n">DOS_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LDOS_up</span><span class="p">))</span>
                    <span class="n">DOS_down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LDOS_down</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">es</span><span class="p">,</span> <span class="n">DOS_up</span><span class="p">,</span> <span class="n">DOS_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">es</span><span class="p">,</span> <span class="n">DOS</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="c1"># sometimes the ldos function returns an error for a certain value of energy</span>
                <span class="c1"># -- we therefore must use a try-except statement</span>
                <span class="c1"># try:</span>
                <span class="n">LDOS</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">ldos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">es</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="c1"># integrate the ldos over all space</span>
                <span class="n">DOS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LDOS</span><span class="p">))</span>
                <span class="c1"># except:</span>
                <span class="c1">#     pass</span>
            <span class="k">return</span> <span class="n">es</span><span class="p">,</span> <span class="n">DOS</span></div>

<div class="viewcode-block" id="Structure.getValleyPolarizedConductance"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getValleyPolarizedConductance">[docs]</a>    <span class="k">def</span> <span class="nf">getValleyPolarizedConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">lead_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">K_prime_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-8</span><span class="p">),</span> <span class="n">K_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">velocities</span><span class="o">=</span><span class="s1">&#39;out_going&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the valley-polarized conductances for a given energy between two leads. Note: This function only makes sense when</span>
<span class="sd">        the bandstructure has two valleys in it. An example is zig-zag edged graphene nanoribbons.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        energy : A value of energy.</span>
<span class="sd">        lead_start : An integer of the lead where electrons are injected.</span>
<span class="sd">        lead_end : An integer of the lead where electrons are transmitting through.</span>
<span class="sd">        K_prime_range : A tuple of length 2 which defines the range where K&#39; would be the polarization. Default: (-np.inf, -1e-8)</span>
<span class="sd">        K_range : A tuple of length 2 which defines the range where K would be the polarization. Default (0, np.inf)</span>
<span class="sd">        velocities : If &#39;out_going&#39;, we only consider velocities &lt;= 0. If &#39;in_coming&#39;, velocities &gt; 0. Default: &#39;out_going&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A tuple of length 2. First element is for K&#39;, second for K.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;You are trying to compute the Valley Conductances for Spin-Polarized calculations. This is currently not supported.&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">smatrix</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">velocities</span> <span class="o">==</span> <span class="s1">&#39;out_going&#39;</span><span class="p">:</span>
            <span class="n">positives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">smatrix</span><span class="o">.</span><span class="n">lead_info</span><span class="p">[</span><span class="n">lead_start</span><span class="p">]</span><span class="o">.</span><span class="n">velocities</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">velocities</span> <span class="o">==</span> <span class="s1">&#39;in_coming&#39;</span><span class="p">:</span>
            <span class="n">positives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">smatrix</span><span class="o">.</span><span class="n">lead_info</span><span class="p">[</span><span class="n">lead_start</span><span class="p">]</span><span class="o">.</span><span class="n">velocities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You have defined the direction of the velocities wrong. It is either &#39;out_going&#39; or &#39;in_coming&#39;.&quot;</span><span class="p">)</span>

        <span class="n">momentas</span> <span class="o">=</span> <span class="n">smatrix</span><span class="o">.</span><span class="n">lead_info</span><span class="p">[</span><span class="n">lead_start</span><span class="p">]</span><span class="o">.</span><span class="n">momenta</span><span class="p">[</span><span class="n">positives</span><span class="p">]</span>
        <span class="n">K_prime_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">momentas</span> <span class="o">&gt;=</span> <span class="n">K_prime_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">momentas</span> <span class="o">&lt;=</span> <span class="n">K_prime_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">K_prime_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">momentas</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">K_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">momentas</span> <span class="o">&gt;=</span> <span class="n">K_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">momentas</span> <span class="o">&lt;=</span> <span class="n">K_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">submatrix</span> <span class="o">=</span> <span class="n">smatrix</span><span class="o">.</span><span class="n">submatrix</span><span class="p">(</span><span class="n">lead_end</span><span class="p">,</span> <span class="n">lead_start</span><span class="p">)</span>
        <span class="n">K_prime_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">submatrix</span><span class="p">[:,</span> <span class="n">K_prime_indices</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
        <span class="n">K_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">submatrix</span><span class="p">[:,</span> <span class="n">K_indices</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">K_prime_T</span><span class="p">,</span> <span class="n">K_T</span><span class="p">)</span></div>

<div class="viewcode-block" id="Structure.getValleyPolarizedCurrent"><a class="viewcode-back" href="../../system.html#qmt.system.Structure.getValleyPolarizedCurrent">[docs]</a>    <span class="k">def</span> <span class="nf">getValleyPolarizedCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lead_end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">K_prime_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-8</span><span class="p">),</span> <span class="n">K_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">velocities</span><span class="o">=</span><span class="s1">&#39;out_going&#39;</span><span class="p">,</span> <span class="n">avg_chem_pot</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the valley-polarized currents between two leads. Note: This function only makes sense when</span>
<span class="sd">        the bandstructure has two valleys in it. An example is zig-zag edged graphene nanoribbons.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lead_start : An integer of the lead where electrons are injected.</span>
<span class="sd">        lead_end : An integer of the lead where electrons are transmitting through.</span>
<span class="sd">        K_prime_range : A tuple of length 2 which defines the range where K&#39; would be the polarization. Default: (-np.inf, -1e-8)</span>
<span class="sd">        K_range : A tuple of length 2 which defines the range where K would be the polarization. Default (0, np.inf)</span>
<span class="sd">        velocities : If &#39;out_going&#39;, we only consider velocities &lt;= 0. If &#39;in_coming&#39;, velocities &gt; 0. Default: &#39;out_going&#39;</span>
<span class="sd">        avg_chem_pot : The average of the chemical potentials between two leads. Default: 1.0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A tuple of length 2. First element is for K&#39;, second for K.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getBias</span><span class="p">()</span>
        <span class="n">kb_T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getKBT</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot calculate valley dependent currents for spin-dependent systems.&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnergyRange</span><span class="p">()</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">energy_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energy_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
            
            <span class="n">KPs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Ks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValleyPolarizedConductance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">lead_start</span><span class="p">,</span> <span class="n">lead_end</span><span class="p">,</span> <span class="n">K_prime_range</span><span class="p">,</span> <span class="n">K_range</span><span class="p">,</span> <span class="n">velocities</span><span class="p">)</span>
                <span class="n">KPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">Ks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">KPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">KPs</span><span class="p">)</span>
            <span class="n">Ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ks</span><span class="p">)</span>

            <span class="n">de</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mu_left</span> <span class="o">=</span> <span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">mu_right</span> <span class="o">=</span> <span class="o">-</span><span class="n">bias</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">avg_chem_pot</span>
            <span class="n">diff_fermi</span> <span class="o">=</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">mu_left</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span> <span class="o">-</span> <span class="n">vectorizedFermi</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">mu_right</span><span class="p">,</span> <span class="n">kb_T</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">de</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">KPs</span> <span class="o">*</span> <span class="n">diff_fermi</span><span class="p">),</span> <span class="n">de</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ks</span> <span class="o">*</span> <span class="n">diff_fermi</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">getWaveFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">),</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">)</span>

    <span class="c1"># currently not working</span>
    <span class="k">def</span> <span class="nf">plotWaveFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">dense</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">oversampling</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plotCurrentDensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">Current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">J</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">dense</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getNSites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span><span class="o">.</span><span class="n">sites</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span><span class="o">.</span><span class="n">sites</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">getChromosome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">chromosome</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getGenes</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">getFromDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(),</span> <span class="n">gene</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
            <span class="n">chromosome</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chromosome</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Kevin Ryczko.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1a',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>