

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>system &mdash; QMT 0.0.1a documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> QMT
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../system.html">Module: system.py</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">QMT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>system</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for system</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">kwant</span>
<span class="kn">import</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">as</span> <span class="nn">sla</span>
<span class="kn">import</span> <span class="nn">cmocean</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">shapes</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">masks</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">helper</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">coloredlogs</span><span class="o">,</span> <span class="nn">verboselogs</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># create logger</span>
<span class="n">coloredlogs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">verboselogs</span><span class="o">.</span><span class="n">VerboseLogger</span><span class="p">(</span><span class="s1">&#39; &lt;-- QMT: model --&gt; &#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Generator"><a class="viewcode-back" href="../system.html#system.Generator">[docs]</a><span class="k">class</span> <span class="nc">Generator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this is a test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dill_model</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_generated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_generated</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dill_model</span><span class="p">))</span>
        <span class="n">m</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_generated</span>
        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">applyMask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">attachLeads</span><span class="p">()</span>
            <span class="n">m</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m</span> </div>

    <span class="c1"># def __reduce__(self):</span>
    <span class="c1">#     return (self.__class__, (self.generator, self.n_generated))</span>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../system.html#system.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main class which stores all of the information needed for kwant as well as functions to make it easier to use kwant (not that it is too difficult).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parser : This takes the YAML configuration file which is read in as a dictionary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>   <span class="bp">self</span><span class="p">,</span>
                    <span class="n">parser</span>
                 <span class="p">):</span>
        <span class="c1"># define the class parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getDevice</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leads</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getLeads</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">spinDependent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">hoppingFunction</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">site1</span><span class="p">,</span> <span class="n">site2</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">site1</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">site2</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onSiteFunction</span><span class="p">(</span><span class="n">pot</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pot</span> <span class="o">+</span> <span class="n">spin</span> <span class="o">*</span> <span class="n">B</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># first construct the lattice</span>
        <span class="n">lattice_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeType</span><span class="p">()</span>
        <span class="n">lattice_constant</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeConstant</span><span class="p">()</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeVectors</span><span class="p">()</span>
        <span class="n">lattice_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getLatticeBasis</span><span class="p">()</span>
        <span class="n">norbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">getNumOrbitals</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lattice_type</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">,</span> <span class="n">lattice_basis</span><span class="p">,</span> <span class="n">norbs</span><span class="o">=</span><span class="n">norbs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Sorry, we do not support the lattice type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lattice_type</span><span class="p">))</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="n">phi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;shapes&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;hoppings&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">[</span><span class="s1">&#39;potentials&#39;</span><span class="p">]):</span>
            
            <span class="c1"># if we want to consider spin dependent transport</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="n">potential</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">neighbors</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">potential</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">neighbors</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attachLeads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leads</span><span class="p">:</span>
                <span class="n">lead_width</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                <span class="n">lead_vector</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span>
                <span class="n">lead_offset</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
                <span class="n">lead_pot</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span>
                <span class="n">lead_hopping</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;hopping&#39;</span><span class="p">]</span>
                <span class="n">lead_phi</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
                <span class="n">lead_r</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>

                <span class="n">sym</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">TranslationalSymmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">orthogVecSlope</span><span class="p">(</span><span class="n">graphene</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">lead_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="o">-</span><span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span>  <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="n">lead_pot</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">lead_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="o">-</span><span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span>  <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onSiteFunction</span><span class="p">,</span> <span class="n">lead_pot</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">lead_up</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">lead_down</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>            
                <span class="n">lead_up</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
                <span class="n">lead_down</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_up</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_down</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lead_r</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_up</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead_down</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leads</span><span class="p">:</span>
                <span class="n">lead_width</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                <span class="n">lead_vector</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span>
                <span class="n">lead_offset</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
                <span class="n">lead_pot</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;potential&#39;</span><span class="p">]</span>
                <span class="n">lead_hopping</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;hopping&#39;</span><span class="p">]</span>
                <span class="n">lead_phi</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
                <span class="n">lead_r</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span>

                <span class="n">sym</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">TranslationalSymmetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">orthogVecSlope</span><span class="p">(</span><span class="n">graphene</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="n">lead_vector</span><span class="p">))</span>
                <span class="n">lead</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="n">lead</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="o">-</span><span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span>  <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">lead_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">lead_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">lead_pot</span>
                <span class="n">lead</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hoppingFunction</span><span class="p">,</span> <span class="n">lead_hopping</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
                <span class="n">lead</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lead_r</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">attach_lead</span><span class="p">(</span><span class="n">lead</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">applyMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">site_value_pairs</span><span class="p">():</span>
            <span class="c1"># if the site is in the body</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># print (s.tag)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">min_tag_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">min_tag_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">min_pos_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">min_pos_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_pos_sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">max_pos_sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">tag_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_tag_sx</span>
        <span class="n">tag_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">min_tag_sy</span>

        <span class="n">tags</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_tag_sx</span><span class="p">)</span>
        <span class="n">tags</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_tag_sy</span><span class="p">)</span>
        <span class="n">positions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_pos_sx</span><span class="p">)</span>
        <span class="n">positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_pos_sy</span><span class="p">)</span>
        <span class="n">masc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">mask</span><span class="p">((</span><span class="n">tag_length</span><span class="p">,</span> <span class="n">tag_width</span><span class="p">),</span> <span class="p">(</span><span class="n">min_pos_sx</span><span class="p">,</span> <span class="n">min_pos_sy</span><span class="p">),</span> <span class="p">(</span><span class="n">max_pos_sx</span><span class="p">,</span> <span class="n">max_pos_sy</span><span class="p">),</span> <span class="n">positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">removed_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">masc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">removed_tags</span> <span class="o">=</span> <span class="n">removed_tags</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">removed_tags</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">removed_tags</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">elem</span><span class="p">)]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">eradicate_dangling</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">finalized</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getPreSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span>

    <span class="k">def</span> <span class="nf">getSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>

    <span class="k">def</span> <span class="nf">visualizeSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">site_lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">site_lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">diagonalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># Compute some eigenvalues of the closed system</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">sparse_mat_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="n">sparse_mat_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat_up</span><span class="p">),</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat_down</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sparse_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">hamiltonian_submatrix</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_mat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">start_lead_id</span><span class="p">,</span> <span class="n">end_lead_id</span><span class="p">):</span>
        <span class="c1"># Compute transmission as a function of energy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">data_up</span><span class="p">,</span> <span class="n">data_down</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">smatrix_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">smatrix_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">data_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix_up</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">start_lead_id</span><span class="p">,</span> <span class="n">end_lead_id</span><span class="p">))</span>
                <span class="n">data_down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix_down</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">start_lead_id</span><span class="p">,</span> <span class="n">end_lead_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data_up</span><span class="p">,</span> <span class="n">data_down</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">smatrix</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">smatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">energy</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smatrix</span><span class="o">.</span><span class="n">transmission</span><span class="p">(</span><span class="n">start_lead_id</span><span class="p">,</span> <span class="n">end_lead_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">getBandStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leadid</span><span class="p">,</span> <span class="n">momenta</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="n">bands_up</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">leadid</span><span class="p">]</span><span class="o">.</span><span class="n">finalized</span><span class="p">())</span>
            <span class="n">bands_down</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">leadid</span><span class="p">]</span><span class="o">.</span><span class="n">finalized</span><span class="p">())</span>
            <span class="n">energies_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands_up</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="n">energies_down</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands_down</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">energies_up</span><span class="p">,</span> <span class="n">energies_down</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">leads</span><span class="p">[</span><span class="n">leadid</span><span class="p">]</span><span class="o">.</span><span class="n">finalized</span><span class="p">())</span>
            <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">momenta</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">energies</span>

    <span class="k">def</span> <span class="nf">getWaveFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_up</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">),</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_down</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">wave_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">energy</span><span class="p">)(</span><span class="n">lead_id</span><span class="p">)</span>

    <span class="c1"># currently not working</span>
    <span class="k">def</span> <span class="nf">plotWaveFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">dense</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">oversampling</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plotCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">Current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">J</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="n">lead_id</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">dense</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getNSites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system_up</span><span class="o">.</span><span class="n">sites</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_system</span><span class="o">.</span><span class="n">sites</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">getDOS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">kwant</span><span class="o">.</span><span class="n">kpm</span><span class="o">.</span><span class="n">SpectralDensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">getCurrentForCut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">energy</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">site_to</span><span class="p">,</span> <span class="n">site_from</span> <span class="p">:</span> <span class="n">site_from</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">site_to</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">site_from</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">site_to</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">Current</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">cut</span><span class="p">,</span> <span class="nb">sum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wfs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">J</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span> <span class="k">for</span>  <span class="n">wf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWaveFunction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>

    <span class="k">def</span> <span class="nf">birth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">kwant</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">n_parents</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>
        <span class="c1"># print(parents)</span>

        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;stack&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span> <span class="n">conditions</span><span class="p">):</span>
                <span class="n">syst</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">getPreSystem</span><span class="p">())</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="n">syst</span><span class="o">.</span><span class="n">sites</span><span class="p">()</span>
                <span class="n">sites_to_del</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pos</span><span class="p">):</span>
                        <span class="n">sites_to_del</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">sites_to_del</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">syst</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span>
                <span class="c1"># print (sites_to_del)</span>
                <span class="c1"># for s in sites_to_add:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">syst</span><span class="p">)</span>
                <span class="c1"># self.visualizeSystem()</span>
                <span class="c1"># self.attachLeads()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;averageNanopores&#39;</span><span class="p">:</span>
            <span class="n">mask_infos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mask_info</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mask_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">mask_info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">mask_info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
                <span class="n">mask_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># print(mask_infos)</span>
            <span class="n">averages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mask_info</span> <span class="ow">in</span> <span class="n">mask_infos</span><span class="p">:</span>
                <span class="n">average</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mask_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># print(np.array(val))</span>
                    <span class="n">average</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="n">averages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">average</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">averages</span><span class="p">)</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">averages</span><span class="p">)):</span>
                <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">whatMask</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">averages</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">applyMask</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">multiMasks</span><span class="p">,</span> <span class="n">masks</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attachLeads</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Kevin Ryczko.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.0.1a',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>